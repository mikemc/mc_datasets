# Download the sequence data for all samples in the Fouhy2016 experiment

library(tidyverse)

dotenv::load_dot_env("../.env")
script_path <- getwd()
data_path <- file.path(Sys.getenv("DATA_DIR"),
    "fouhy2016")

# The sample metadata generated by `sample_metadata.R` includes the SRA run
# accessions that we need for downloading from NCBI
tb <- readr::read_csv(file.path(script_path, "sample_metadata.csv"))

# Use prefetch to download with ascp if available, and fall back to http otherwise.
command <- paste("prefetch", 
    "--ascp-path", Sys.getenv("ASCP_PATH") %>% shQuote,
    glue::collapse(tb$SRA_run, sep=" "))
system(command)
# Convert to fastq.
command <- paste("fastq-dump --split-3 --gzip",
        "--outdir", file.path(data_path, "reads"),
        glue::collapse(tb$SRA_run, sep=" ")
        )
system(command)
# Note, will download the .sra files to whatever directory is set by the sra
# toolkit config. These can be deleted after converting to fastq.
# Set this directory with `vdb-config` (see
# https://github.com/ncbi/sra-tools/wiki/Toolkit-Configuration)

# TODO: Delete the .sra files after fastq conversion (?)
# Also, see https://github.com/ncbi/sra-tools/issues/71 to consider alternate
# method

#################

command <- paste("prefetch", 
    "--ascp-path", Sys.getenv("ASCP_PATH") %>% shQuote,
    glue::collapse(tb$SRA_run[c(1:2, 8:9)], sep=" "))
system(command)
# Convert to fastq
command <- paste("fastq-dump --split-3 --gzip",
        "--outdir", file.path(data_path, "reads"),
        glue::collapse(tb$SRA_run[c(1:2, 8:9)], sep=" ")
        )
system(command)

runs <- split(tb$SRA_run, tb$Sequencer)
runs$MiSeq[1:2]
runs$PGM[1:2]

command <- paste("fastq-dump --split-spot --split-3 --gzip",
        "--outdir", file.path(data_path, "reads"),
        glue::collapse(runs$MiSeq[1:2], sep=" ")
        )
system(command)

# Note the use of --split-3 to split the MiSeq reads
