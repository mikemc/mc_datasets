# Download the sequence data for the Costea2017 Phase 3 experiment from the
# ENA, which may be faster and more reliable than downloading from NCBI.

library(tidyverse)
library(magrittr)

dotenv::load_dot_env("../.env")
script_path <- getwd()
data_path <- file.path(Sys.getenv("DATA_DIR"),
    "costea2017")
aspera_path <- Sys.getenv("ASCP_PATH") %>%
    str_split(pattern = "\\|") %>%
    {.[[1]][1]} %>%
    dirname %>%
    dirname

# The sample metadata generated by `sample_metadata.R`, which includes the ENA
# run accessions that we need for downloading from ENA (labeled as SRA_run).
# Only includes the Phase 3 samples.
sam_tb <- readr::read_csv(file.path(script_path, "sample_metadata.csv"))
# Sequence data info, manually downloaded from
# https://www.ebi.ac.uk/ena/data/view/PRJEB14847
seq_tb <- readr::read_tsv(file.path(script_path, "PRJEB14847.tsv"))
# Get the (combined for reads1 + reads2) file size of each sample in GB
file_sizes <- seq_tb$fastq_bytes %>%
    str_split(";", simplify = TRUE) %>%
    as_tibble %>%
    mutate(V1 = as.numeric(V1), V2 = as.numeric(V2),
        file_size = (V1 + V2) / 1e9) %$%
    file_size
seq_tb <- seq_tb %>%
    mutate(fastq_GB = file_sizes)
# Join the download information in seq_tb to the sample data for _Phase 3 only_
tb <- left_join(sam_tb, seq_tb, by = c("Run_accession" = "run_accession"))

## Download with ascp (aspera connect command line tool)
# The aspera urls are in the format "url/for/read1;url/for/read2"
aspera_urls <- tb$fastq_aspera %>% str_split(";", simplify=TRUE) %>% c
commands <- paste(
    file.path(aspera_path, "bin/ascp"),
    "-QT -l 300m -P33001 -i", 
    file.path(aspera_path, "etc/asperaweb_id_dsa.openssh"),
    paste0("era-fasp@", aspera_urls),
    file.path(data_path, "reads")
    )
walk(commands, system)
# For testing the commands:
system(commands[5])

# ## Download with wget:
# ftp_urls <- tb$fastq_ftp %>% str_split(";", simplify=TRUE) %>% c
# dir.create(file.path(data_path, "reads"), recursive = TRUE)
# commands <- paste("wget", "-P", file.path(data_path, "reads"), 
#     paste0("ftp://", ftp_urls)
# walk(commands, system)

## Check dowloaded files against md5sums
downloads <- aspera_urls %>% 
    str_extract("ERR[0-9]*_[1-2]\\.fastq\\.gz") %>%
    file.path(data_path, "reads", .)
md5sums_expected <- tb$fastq_md5 %>% str_split(";", simplify=TRUE) %>% c
md5sums_actual <- tools::md5sum(downloads)
# Fraction of files that were successfully downloaded and gave an md5
mean(!is.na(md5sums_actual))
# Check that the downloaded files match the expected md5
all(md5sums_expected == md5sums_actual, na.rm = TRUE)

